parameters:
  consider-branch:
    type: boolean
    default: true
    description: "Should we only consider jobs running on the same branch?"
  block-workflow:
    type: boolean
    # this is false at COMMAND level as intention is to only block CURRENT job.
    default: false
    description: "If true, this job will block until no other workflows with an earlier timestamp are running. Typically used as first job."
  time:
    type: string
    default: "10"
    description: "How many minutes to wait before giving up."
  dont-quit:
    type: boolean
    default: false
    description: "Quitting is for losers. Force job through once time expires instead of failing."
  only-on-branch:
    type: string
    default: "*"
    description: "Only queue on specified branch"
  only-on-workflow:
    type: string
    default: "*"
    description: "Only queue on a specified workflow. Consider combining this with `consider-branch`:`false`."
  vcs-type:
    type: string
    default: "github"
    description: "Override VCS to 'bitbucket' if needed."
  confidence:
    type: string
    default: "1"
    description: "Due to scarce API, we need to requery the recent jobs list to ensure we're not just in a pending state for previous jobs.  This number indicates the threhold for API returning no previous pending jobs. Default is a single confirmation."
  circleci-api-key:
    type: env_var_name
    default: CIRCLECI_API_KEY
    description: "In case you use a different Environment Variable Name than CIRCLECI_API_KEY, supply it here."
  tag-pattern:
    type: string
    default: ""
    description: "Set to queue jobs using a regex pattern f.ex '^v[0-9]+\\.[0-9]+\\.[0-9]+$' to filter CIRCLECI_TAG"
  job-regex:
    type: string
    default: ""
    description: "Allow multiple job names to be blocked until front of line f.ex '^runTests*'"
  circleci-hostname:
    type: string
    default: "circleci.com"
    description: "For server user to specifiy custom hostname for their server"

steps:
  - run:
      name: Queue Until Front of Line
      command: <<include(../scripts/loop.bash)>>
      environment:  
        tag_pattern: <<parameters.tag-pattern>>
        CIRCLECI_BASE_URL: https://<<parameters.circleci-hostname>>
        max_time: <<parameters.time>>
        CONFIDENCE_THRESHOLD: <<parameters.confidence>>
        DONT_QUIT: <<parameters.dont-quit>>
        ONLY_ON_BRANCH: <<parameters.only-on-branch>>
        CCI_API_KEY_NAME: << parameters.circleci-api-key >>
        FILTER_BRANCH: << parameters.consider-branch >>
        VCS_TYPE: <<parameters.vcs-type>>
        JOB_REGEXP: <<parameters.job-regex>>
        BLOCK_WORKFLOW: <<parameters.block-workflow>>
        ONLY_ON_WORKFLOW: <<parameters.only-on-workflow>>